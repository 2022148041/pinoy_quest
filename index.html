<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Quests: Live üèÜ</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333; min-height: 100vh; margin: 0; padding: 15px;
            display: flex; justify-content: center; align-items: flex-start;
        }

        .container {
            background: rgba(255, 255, 255, 0.96);
            width: 100%; max-width: 450px;
            padding: 25px; border-radius: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            text-align: center; margin-top: 20px;
        }

        h1 { margin: 0 0 5px 0; color: #2d3436; font-size: 1.6em; }
        .subtitle { color: #636e72; font-size: 0.85em; margin-bottom: 20px; }

        /* --- CHARACTER GRID --- */
        .char-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
            margin-bottom: 25px;
        }
        .char-btn {
            background: #f1f2f6; border: 2px solid #dfe6e9;
            border-radius: 15px; padding: 10px 5px; cursor: pointer;
            transition: all 0.2s; position: relative;
        }
        .char-btn.active { border-color: #6c5ce7; background: #e0dcfc; transform: scale(1.05); }
        .char-icon { font-size: 1.5em; display: block; margin-bottom: 5px; }
        .char-name { font-size: 0.7em; font-weight: bold; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .char-score { 
            position: absolute; top: -5px; right: -5px; 
            background: #ff7675; color: white; font-size: 0.7em; 
            width: 20px; height: 20px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-weight: bold;
        }

        /* --- UI ELEMENTS --- */
        .hidden { display: none !important; }
        .btn { border: none; padding: 15px; width: 100%; font-size: 1em; border-radius: 12px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: #6c5ce7; color: white; }
        .btn-success { background-color: #00b894; color: white; }
        .btn-outline { background: transparent; border: 2px solid #b2bec3; color: #636e72; }
        .btn-gold { background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); color: white; }
        
        /* --- MISSION CARDS --- */
        .main-mission-section { text-align: left; background: #fff0f0; border: 2px solid #ff7675; border-radius: 15px; padding: 15px; margin-bottom: 20px; }
        .mm-header { font-size: 0.9em; font-weight: 800; color: #d63031; text-transform: uppercase; margin-bottom: 10px; }
        .mm-task { font-size: 1em; font-weight: 600; margin-bottom: 10px; line-height: 1.4; }

        .quest-card { background: #fff; border-radius: 15px; padding: 20px; min-height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center; margin-bottom: 20px; border: 2px dashed #b2bec3; }
        .quest-title { font-size: 1.3em; font-weight: 800; color: #6c5ce7; margin-bottom: 10px; text-transform: uppercase; }
        .quest-desc { font-size: 1em; line-height: 1.4; color: #555; }
        .status-badge { background: #ffeaa7; color: #d63031; font-size: 0.7em; padding: 5px 10px; border-radius: 20px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; }

        /* --- LEADERBOARD --- */
        .leaderboard { text-align: left; background: #f8f9fa; padding: 15px; border-radius: 15px; margin-top: 30px; }
        .lb-title { font-size: 0.9em; text-transform: uppercase; color: #b2bec3; font-weight: bold; margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center;}
        .lb-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dfe6e9; font-size: 0.9em; }
        .lb-refresh { font-size: 1.2em; cursor: pointer; text-decoration: none; border:none; background:none; }
        
        #passwordArea, #gameArea { animation: popIn 0.3s ease; }
        @keyframes popIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }
        
        input[type="password"] { width: 100%; padding: 12px; border: 2px solid #dfe6e9; border-radius: 10px; font-size: 1em; text-align: center; margin-bottom: 10px; outline: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üèÜ Trip Quests</h1>
        <p class="subtitle" id="mainStatus">Select your character</p>

        <div class="char-grid" id="charGrid"></div>

        <div id="passwordArea" class="hidden">
            <p>Enter Password for <strong id="pwCharName">...</strong></p>
            <input type="password" id="pwInput" placeholder="Passcode">
            <button class="btn btn-primary" onclick="checkPassword()">Unlock Profile üîì</button>
            <button class="btn btn-outline" onclick="goBack()">Cancel</button>
        </div>

        <div id="gameArea" class="hidden">
            <div id="mainMissionDisplay"></div>
            
            <hr style="border:0; border-top: 1px solid #eee; margin: 20px 0;">
            <p class="subtitle">üëá Random Side Missions üëá</p>

            <div class="quest-card">
                <div id="activeMissionUI" class="hidden">
                    <div class="status-badge">Side Mission Active</div>
                    <div class="quest-title" id="qTitle">...</div>
                    <div class="quest-desc" id="qDesc">...</div>
                </div>
                <div id="noMissionUI">
                    <div class="quest-title" style="color:#b2bec3">Ready?</div>
                    <div class="quest-desc">Pull a random side quest!</div>
                </div>
            </div>

            <div id="actionButtons">
                <button class="btn btn-primary" id="btnDraw" onclick="drawMission()">üé≤ Get Random Mission</button>
                <button class="btn btn-success hidden" id="btnComplete" onclick="completeMission()">‚úÖ Side Mission Complete (+1)</button>
                <button class="btn btn-outline hidden" id="btnSkip" onclick="skipMission()">üè≥Ô∏è Skip (-1 Pt)</button>
            </div>
            
            <button class="btn btn-outline" style="margin-top:20px; border:none; font-size:0.8em" onclick="goBack()">‚¨ÖÔ∏è Logout</button>
        </div>

        <div class="leaderboard">
            <div class="lb-title">
                üèÜ Live Scores
                <button class="lb-refresh" onclick="fetchLiveScores()">üîÑ</button>
            </div>
            <div id="lbList">Loading scores...</div>
            <div style="font-size:0.6em; color:#aaa; margin-top:5px; text-align:center;">
                Note: Scores may take 5 mins to update on other phones.
            </div>
        </div>
    </div>

    <script>
        // ******************************************************
        // ‚úÖ CONFIGURATION SECTION
        // ******************************************************
        
        // 1. QUESTS DATABASE (Read-Only)
        const questsCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSz6PuMPKC6l3pyXFJI5S8HwRIBMOcwj_ZUez0ifEjJz7Ft5PKsUSZ4XRarDIC8kg-nHEgylWqUpRa8/pub?output=csv"; 
        
        // 2. SCORES DATABASE (Read-Only CSV of Form Responses)
        // [ACTION] PASTE YOUR NEW LINK BELOW!
        const responseSheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS0VzHhZKX33E6rQ8BdgqRxSqrwV3lP-K_8_nzDWV4N9iiAUux1853s-Lrm3e84UzpBVYm-PO9NQoXp/pub?gid=1421738490&single=true&output=csv"; 
        
        // 3. GOOGLE FORM SUBMISSION (Write-Only)
        const formURL = "https://docs.google.com/forms/d/e/1FAIpQLSdclxkCaS0FrMSrCfoGw1-8GL3BDA_qIk6AN8snL_goq49YYw/formResponse";
        const entryName = "entry.534702092"; 
        const entryQuest = "entry.650581964";

        const characters = [
            { id: "c1", name: "Roma", icon: "ü¶Å" },
            { id: "c2", name: "Heaven", icon: "üê®" },
            { id: "c3", name: "Yuvaan", icon: "ü§°" }, 
            { id: "c4", name: "Eddy", icon: "üçî" },
            { id: "c5", name: "Yuki", icon: "üß©" },
            { id: "c6", name: "Sneghaa", icon: "üò¥" },
            { id: "c7", name: "Sarvina", icon: "üí∞" }
        ];

        const mainMissions = [
            { name: 'Heaven', pw: 'heaven1234', target: 'Roma', task: 'Make your target to race with you thrice throughout the trip. Can be ANYWHERE!' },
            { name: 'Roma', pw: 'roma1111', target: 'Eddy', task: "You must pat your Target hard on the back once every day. Don't kill the boi!" },
            { name: 'Eddy', pw: 'eddy0000', target: 'Yuki', task: 'You must record a short video of your target answering a "Question of the Day" every day.' },
            { name: 'Sneghaa', pw: 'sneghaa4321', target: 'Heaven', task: 'Make a 3-step dab with your target every single day. The 3-step can vary.' },
            { name: 'Yuki', pw: 'yukichan', target: 'Sarvina', task: 'You must physically "fix" your Target‚Äôs appearance once every day.' },
            { name: 'Sarvina', pw: 'sarvinavina', target: 'Sneghaa', task: 'Make your target to point to the sky and take picture of them once every day.' },
            { name: 'Yuvaan', pw: 'gommale', target: 'Single', task: '‡Æ®‡Ææ‡Æü‡Øç‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡Æø‡Æ≤‡Øç ‡Æ®‡ØÇ‡Æ±‡ØÅ ‡Æ§‡Æü‡Æµ‡Øà, ‡Æâ‡Æ®‡Øç‡Æ§‡Æ©‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øà ‡Æé‡Æ¥‡ØÅ‡Æ§‡ØÅ‡ÆÆ‡Øç ‡Æé‡Æ©‡Øç ‡Æ™‡Øá‡Æ©‡Ææ?\n‡Æé‡Æ¥‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ‡ÆÆ‡Øç ‡Æé‡Æ±‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ ‡ÆÆ‡Øä‡ÆØ‡Øç‡Æï‡Øç‡Æï, ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡ØÅ‡ÆÆ‡Øç ‡ÆÜ‡Æ©‡Æ§‡ØÜ‡Æ©‡Øç‡Æ© ‡Æ§‡Øá‡Æ©‡Ææ?' }
        ];

        // ******************************************************

        let allQuests = [];
        let currentPlayer = null;
        let liveScores = {}; // Stores { Roma: 10, Heaven: 5 }
        let mainMissionStatus = {}; // Stores { Roma: true, Heaven: false }

        // Local State just for ACTIVE CURRENT QUEST (so it persists on refresh)
        let localState = {}; 

        window.onload = async function() {
            // Load Quests
            try {
                const res = await fetch(questsCSV);
                const data = await res.text();
                parseQuestCSV(data);
            } catch (e) { console.error("Quest Load Error", e); }

            // Load Local Active Quests
            const saved = localStorage.getItem('tripQuestLocal');
            if(saved) localState = JSON.parse(saved);

            // Initial UI
            renderGrid();
            document.getElementById('lbList').innerText = "Connecting to Google...";
            
            // FETCH LIVE SCORES
            fetchLiveScores();
        };

        // --- LIVE DATA SYNC ---
        async function fetchLiveScores() {
            if (responseSheetURL.includes("PASTE")) {
                document.getElementById('lbList').innerText = "‚ö†Ô∏è Config Error: Missing CSV Link";
                return;
            }

            try {
                const res = await fetch(responseSheetURL + "&t=" + Date.now()); // timestamp to bust cache
                const text = await res.text();
                parseScoreCSV(text);
                renderLeaderboard();
                
                // If logged in, update UI in case Main Mission status changed
                if(currentPlayer) {
                    const charName = characters.find(c=>c.id===currentPlayer).name;
                    const mmData = mainMissions.find(m=>m.name === charName);
                    renderMainMissionUI(charName, mmData);
                }
            } catch (e) {
                console.error("Score Fetch Error", e);
                document.getElementById('lbList').innerText = "‚ö†Ô∏è Network Error";
            }
        }

        function parseScoreCSV(csvText) {
            // Reset counts
            characters.forEach(c => { 
                liveScores[c.name] = 0; 
                mainMissionStatus[c.name] = false; 
            });

            const rows = csvText.split('\n').slice(1); // Skip header
            rows.forEach(row => {
                // CSV FORMAT: Timestamp, Name, Quest
                // We need to be careful about commas inside quotes
                const cols = row.split(','); 
                // Simple parsing (assuming Name is Col 1, Quest is Col 2)
                if (cols.length >= 3) {
                    const name = cols[1].trim();
                    const quest = cols.slice(2).join(',').trim(); // Rejoin rest in case of commas
                    
                    if (liveScores[name] !== undefined) {
                        if (quest.startsWith("MAIN MISSION:")) {
                            liveScores[name] += 10;
                            mainMissionStatus[name] = true;
                        } else if (quest.includes("SKIP")) {
                            liveScores[name] -= 1;
                        } else {
                            liveScores[name] += 1;
                        }
                    }
                }
            });
        }

        // --- ACTIONS ---

        function completeMainMission(taskTitle) {
            if(!confirm("Complete Main Mission? (+10 Pts)")) return;
            
            // Optimistic Update (Show it immediately)
            const charName = characters.find(c=>c.id===currentPlayer).name;
            liveScores[charName] += 10;
            mainMissionStatus[charName] = true;
            
            // Send
            sendToGoogle(charName, "MAIN MISSION: " + taskTitle);
            
            // Update UI
            const mmData = mainMissions.find(m=>m.name === charName);
            renderMainMissionUI(charName, mmData);
            renderLeaderboard();
            alert("Sent! (Wait 5 mins for others to see)");
        }

        function completeMission() {
            const charName = characters.find(c=>c.id===currentPlayer).name;
            const questTitle = localState[currentPlayer].title;
            
            // Optimistic Update
            liveScores[charName] += 1;
            
            // Send
            sendToGoogle(charName, questTitle);
            
            // Clear Local
            localState[currentPlayer] = null;
            saveLocal();
            
            updateMissionUI();
            renderLeaderboard();
            alert("Done! +1 Point");
        }

        function skipMission() {
            if(!confirm("Skip? (-1 Point)")) return;
            const charName = characters.find(c=>c.id===currentPlayer).name;
            
            // Optimistic Update
            liveScores[charName] -= 1;

            // Send Penalty Log
            sendToGoogle(charName, "SKIP (-1): " + localState[currentPlayer].title);
            
            // Clear Local
            localState[currentPlayer] = null;
            saveLocal();
            
            updateMissionUI();
            renderLeaderboard();
        }

        function drawMission() {
            if(allQuests.length === 0) return alert("Loading quests...");
            const rand = allQuests[Math.floor(Math.random() * allQuests.length)];
            
            localState[currentPlayer] = rand;
            saveLocal();
            updateMissionUI();
        }

        // --- UI RENDERING ---

        function renderLeaderboard() {
            const list = document.getElementById('lbList');
            list.innerHTML = "";
            
            const sorted = characters.map(c => {
                return { name: c.name, score: liveScores[c.name] || 0 };
            }).sort((a,b) => b.score - a.score);

            sorted.forEach(p => {
                const row = document.createElement('div');
                row.className = "lb-row";
                row.innerHTML = `<span class="lb-name">${p.name}</span><span>${p.score} pts</span>`;
                list.appendChild(row);
            });
        }

        function renderMainMissionUI(myName, myData) {
            const isDone = mainMissionStatus[myName]; // Check calculated status
            const section = document.getElementById('mainMissionDisplay');
            
            if (isDone) {
                section.innerHTML = `
                    <div class="main-mission-section" style="background:#e3fce3; border-color:#00b894;">
                        <div class="mm-header" style="color:#00b894">‚úÖ MAIN MISSION COMPLETED</div>
                        <div class="mm-task">Target: <strong>${myData.target}</strong> eliminated.</div>
                    </div>`;
            } else {
                section.innerHTML = `
                    <div class="main-mission-section">
                        <div class="mm-header">
                            ‚ö†Ô∏è YOUR MAIN MISSION
                            <span style="font-size:0.8em; color:#555">Target: <strong>${myData.target}</strong></span>
                        </div>
                        <div class="mm-task">${myData.task}</div>
                        <button class="btn btn-gold" onclick="completeMainMission('${myData.task}')">üèÜ Mark Complete (+10 Pts)</button>
                    </div>`;
            }
        }

        function updateMissionUI() {
            const currentQuest = localState[currentPlayer];
            if (currentQuest) {
                document.getElementById('activeMissionUI').classList.remove('hidden');
                document.getElementById('noMissionUI').classList.add('hidden');
                document.getElementById('qTitle').innerText = currentQuest.title;
                document.getElementById('qDesc').innerText = currentQuest.desc;
                document.getElementById('btnDraw').classList.add('hidden');
                document.getElementById('btnComplete').classList.remove('hidden');
                document.getElementById('btnSkip').classList.remove('hidden');
            } else {
                document.getElementById('activeMissionUI').classList.add('hidden');
                document.getElementById('noMissionUI').classList.remove('hidden');
                document.getElementById('btnDraw').classList.remove('hidden');
                document.getElementById('btnComplete').classList.add('hidden');
                document.getElementById('btnSkip').classList.add('hidden');
            }
        }

        // --- AUTH & HELPERS ---

        function initiateLogin(id) {
            currentPlayer = id;
            const charName = characters.find(c=>c.id===id).name;
            document.getElementById('charGrid').classList.add('hidden');
            document.getElementById('passwordArea').classList.remove('hidden');
            document.getElementById('pwCharName').innerText = charName;
            document.getElementById('pwInput').value = "";
            document.getElementById('pwInput').focus();
        }

        function checkPassword() {
            const input = document.getElementById('pwInput').value;
            const charName = characters.find(c=>c.id===currentPlayer).name;
            const missionData = mainMissions.find(m => m.name === charName);

            if (missionData && input === missionData.pw) {
                document.getElementById('passwordArea').classList.add('hidden');
                document.getElementById('gameArea').classList.remove('hidden');
                document.getElementById('mainStatus').innerText = `Logged in as: ${charName}`;
                renderMainMissionUI(charName, missionData);
                updateMissionUI();
            } else {
                alert("Wrong Password! üö´");
            }
        }

        function goBack() {
            currentPlayer = null;
            document.getElementById('passwordArea').classList.add('hidden');
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('charGrid').classList.remove('hidden');
            document.getElementById('mainStatus').innerText = "Select your character";
        }

        function renderGrid() {
            const grid = document.getElementById('charGrid');
            grid.innerHTML = "";
            characters.forEach(c => {
                const btn = document.createElement('div');
                btn.className = "char-btn";
                btn.onclick = () => initiateLogin(c.id);
                btn.innerHTML = `
                    ${liveScores[c.name] > 0 ? `<div class="char-score">${liveScores[c.name]}</div>` : ''}
                    <span class="char-icon">${c.icon}</span>
                    <span class="char-name">${c.name}</span>
                `;
                grid.appendChild(btn);
            });
        }

        function sendToGoogle(name, quest) {
            const formData = new FormData();
            formData.append(entryName, name);
            formData.append(entryQuest, quest);
            fetch(formURL, { method: "POST", mode: "no-cors", body: formData }).catch(e=>{});
        }

        function parseQuestCSV(text) {
            const rows = text.split('\n').slice(1);
            rows.forEach(row => {
                const c = row.split(',');
                if(c.length >= 2 && c[0].trim()) allQuests.push({ desc: c[0].trim(), title: c[1].trim() });
            });
        }

        function saveLocal() {
            localStorage.setItem('tripQuestLocal', JSON.stringify(localState));
        }

        function hardReset() {
            if(confirm("Clear LOCAL app data? (Does not delete Google Sheets)")) {
                localStorage.removeItem('tripQuestLocal');
                location.reload();
            }
        }
    </script>
</body>
</html>
